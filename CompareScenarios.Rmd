---
title: "Compare Atlantis Scenario Output"
author: "Robert Wildermuth"
date: "1/26/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load atlantisom package and replacement functions
```{r}
library(atlantisom)
library(tidyverse)
library(tidync)
library(ggforce)
library(oce)

source("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/load_neus_v1_runprm.R")
source("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/run_truth.R")

source("C:/Users/rwildermuth/Dropbox/PhD_UMass/GB_BBN/thresholdsLookup.R")
```

Function to convert nitrogen into tonnes wet weight biomass for biomass pool inverts
```{r}
# Following Atlantis wiki (https://confluence.csiro.au/display/Atlantis/Atlantis+Output+Files)
# "* X_CN * mg_2_tonne where X_CN is the Redfield ratio specified in the biol.prm file (typically 5.7) and mg_2_tonne is 0.00000002"

ConvertBiomassPool <- function(groupSN, # structural nitrogen (mg) from Out.nc
                               X_CN = 5.7, # C:N Redfield ratio from biol.prm, called 'redfieldcn' in {atlantisom}
                               wetdry = 20, # wet to ash-free dry weight, 'k_wetdry' in biol.prm, same as 'kgw2d' in {atlantisom}
                               X_RS = 2.65 # Ratio of reserve to structural N in biol.prm
                               ){
  
  #Calculate wet weight of biomass pools using conversion in Atlantis manual, pg 151: weight_g = (1 + 2.65) * strutural N

  mgTotN <- groupSN * (1 + X_RS)

  # convert from mg N dry weight to mT wet weight biomass
  biomass <- mgTotN * wetdry * X_CN / 1e9
  return(biomass)
}

ConvertBiomassPool(groupSN = 10000)
```

Function to extract data and compile dataset for comparison
```{r}
CompileNEUSIndicators <- function(bdnLookup,
                                  scenario,
                                  dir, 
                                  file_fgs,
                                  file_bgm,
                                  select_groups, 
                                  file_init,
                                  file_biolprm){

# Pull in the data from Atlantis using modified run_truth()
truth <- run_truth(scenario = scenario,
                   dir = dir,
                   file_fgs = file_fgs,
                   file_bgm = file_bgm,
                   select_groups = select_groups,
                   file_init = file_init,
                   file_biolprm = file_biolprm,
                   file_runprm = "NEUSv1",
                   # saves to folder containing the Atlantis output
                   save = TRUE)

# Get the catches by species for Georges Bank
# Subset to Georges Bank boxes and apply biomass conversion
bio_catchGB <- calc_biomass_age(nums = truth$catch,
                                resn = truth$resn, structn = truth$structn, biolprm = truth$biol)
bio_catchGB <- bio_catchGB %>% filter(polygon %in% c(5, 7:11, 19)) %>%
                  # Divide box 5 values in half 
                  mutate(atoutput = case_when(polygon == 5 ~ atoutput/2,
                                              polygon != 5 ~ atoutput)) 
bio_catchGB <- aggregate(atoutput ~ species + time,
                         data = bio_catchGB, sum)


aggBioCatchGB <- merge(bio_catchGB, truth$bio_catch, by = c("species", "time"))
aggBioCatchGB$propGB <- with(aggBioCatchGB, atoutput.x/atoutput.y)

# Need to change 'time' range to match load_nc() output
truth$catch_all <- truth$catch_all %>% mutate(time = as.integer(round(time-30)))

# get 'catch_all' in terms of group names
fxnlGroups <- load_fgs(dir, file_fgs = file_fgs)

codeNameMatch <- merge(truth$catch_all, fxnlGroups[, c("Code", "Name")], by.x = "species", by.y = "Code")

truth$catch_all$species <- codeNameMatch$Name

# multiply .txt catch by Georges Bank proportions and create pseudo-data time series
catchGB <- merge(truth$catch_all, aggBioCatchGB, by = c("species", "time"))
# remove initial year and unneeded columns
catchGB <- catchGB %>% filter(time != 0) %>%
              dplyr::select(species, time, atoutput, propGB) %>%
              mutate(catchGB = atoutput * propGB)


# Aggregate catch based on fish groups
commGF <- catchGB %>% 
              filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "groundfish", "Name"]) %>%
              group_by(time) %>% 
              dplyr::summarize(commGF = sum(catchGB))
# ggplot() + geom_line(data = commGF, aes(x=time,y=commGF))

commPel <- catchGB %>% 
              filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "forage", "Name"]) %>%
              group_by(time) %>% 
              dplyr::summarize(commPel = sum(catchGB))
# ggplot() + geom_line(data = commPel, aes(x=time,y=commPel))

# need to calculate catch of invertebrate groups similar to run_truth()
# 1. Pull catches for entire system
catchConnect <- tidync(file.path(dir, paste0(scenario, "TOTCATCH.nc")))
catchVars <- catchConnect %>% activate("D1,D0") %>% hyper_vars() # %>% select(name)
catchVars <- catchVars$name

search <- character()
for(i in indBDNLookup[indBDNLookup$BNindexGroup == "inverts", "Code"]){
# for(i in paste(indBDNLookup[indBDNLookup$BNindexGroup == "inverts", "Code"],
#                "Catch", sep = "_")){
  search <- c(search, grep(i, catchVars, fixed = TRUE, value = TRUE))
  }


# sfCatchNC <- catchConnect %>% activate(noquote("BFS_Catch_FC4")) %>% #activate(search[1]) %>%
#                 hyper_tibble()
sfCatchNC <- catchConnect %>% activate("D1,D0") %>% 
                hyper_tibble()

sfCatchNC <- sfCatchNC %>% select(b, t, numlayers, topk, all_of(search))

# Check that TOTCATCH.nc matches Catch.txt
# totCatchCheck <- sfCatchNC %>% group_by(t) %>%
#                     dplyr::summarize(Tot_BFS_Catch = sum(Tot_BFS_Catch),
#                                      Tot_BFS_RecCatch = sum(Tot_BFS_RecCatch),
#                                      Tot_BFS_Discards = sum(Tot_BFS_Discards),
#                                      Tot_BML_Catch = sum(Tot_BML_Catch),
#                                      Tot_BML_RecCatch = sum(Tot_BML_RecCatch),
#                                      Tot_BML_Discards = sum(Tot_BML_Discards))
# Values in "Catch" column similar to Catch.txt


# 2. pull out just the Georges Bank catches
commSF <- sfCatchNC %>% filter(b %in% c(5, 7:11, 19)) %>%
                  # Divide box 5 values in half 
                  mutate(Tot_BFS_Catch  = case_when(b == 5 ~ Tot_BFS_Catch /2,
                                                    b != 5 ~ Tot_BFS_Catch ), 
                         Tot_BML_Catch  = case_when(b == 5 ~ Tot_BML_Catch /2,
                                                    b != 5 ~ Tot_BML_Catch ),
                         Tot_PWN_Catch  = case_when(b == 5 ~ Tot_PWN_Catch /2,
                                                    b != 5 ~ Tot_PWN_Catch )) 

# 3. multiply CATCH.txt by the GB ratio
# Don't need to find 'biocatch' amounts, since can just pull relevant box total catch for groups of interest
# and can keep the given values as biomass of catch in tonnes

# 4. add species within inverts group together
commSF$commSF <- rowSums(commSF[ ,c("Tot_BFS_Catch", "Tot_BML_Catch", "Tot_PWN_Catch")])
commSF <- commSF %>% select(b, t, numlayers, topk, Tot_BFS_Catch, Tot_BML_Catch, Tot_PWN_Catch, commSF) %>%
              group_by(t) %>%
              dplyr::summarize(commSF = sum(commSF)) 
commSF <- commSF %>% mutate(time = 0:(length(commSF)-1))# ((t/(60*60*24))-1)/365) #%>%
              #filter(time != 0) %>%
              #filter(time <= 50)


# ggplot() + geom_line(data = commSF, aes(x=t,y=commSF))

#Find biomasses for age-structured fish groups
# First convert to biomass (mT)
biomassTruth <- calc_biomass_age(nums = truth$nums,
                                 resn = truth$resn, structn = truth$structn, biolprm = truth$biol)

groundGB <- biomassTruth %>% 
              filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "groundfish", "Name"]) %>%
              filter(polygon %in% c(5, 7:11, 19)) %>%
              group_by(time) %>% 
              dplyr::summarize(ground = sum(atoutput))
# ggplot() + geom_line(data = groundGB, aes(x=time,y=ground))

forageGB <- biomassTruth %>% 
              filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "forage", "Name"]) %>%
              filter(polygon %in% c(5, 7:11, 19)) %>%
              group_by(time) %>% 
              dplyr::summarize(forage = sum(atoutput))
# ggplot() + geom_line(data = forageGB, aes(x=time,y=forage))

fgs <- load_fgs(dir = dir, file_fgs = file_fgs)
bps <- load_bps(dir = dir, fgs = file_fgs, file_init = file_init)
allboxes <- load_box(dir = dir, file_bgm = file_bgm)
bboxes <- get_boundary(allboxes)
invertsGB <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = indBDNLookup[indBDNLookup$BNindexGroup == "inverts", "Name"],
                     select_variable = "N", bboxes = bboxes)
invertsGB <- invertsGB %>% filter(polygon %in% c(5, 7:11, 19))

# Have to translate into biomass
invertsGB <- invertsGB %>% mutate(inverts = ConvertBiomassPool(groupSN = atoutput))

invertsGB <- invertsGB %>% group_by(time) %>% 
          dplyr::summarize(inverts = sum(inverts))
# ggplot() + geom_line(data = invertsGB, aes(x=time,y=inverts))

# ----------- Habitats -----------------

# use condition factor as indices for habitat calculations
condition <- merge(truth$resn, truth$structn, by = c("species", "agecl", "polygon", "layer", "time"))
condition$condition <- condition$atoutput.x/condition$atoutput.y

# test6 <- condition %>% filter(condition < 2.65)
# test6 <- condition %>% filter(condition > 2.65)
# unique(unique(test6[,-c(6:8)])[, c("species", "agecl")])
# dim(condition); dim(test6)

# need to select by mature age classes
matOgive <- truth$biolprm$maturityogive
matOgive <- merge(matOgive, fxnlGroups[, c("Code", "Name")], by.x = "code", by.y = "Code")
names(matOgive)[which(names(matOgive) == " agecl10")] <- "agecl10"
matOgive <- matOgive %>% dplyr::select("Name", paste0("agecl", 1:10)) %>%
              pivot_longer(cols = starts_with("agecl"), names_to = "agecl",
                           names_prefix = "agecl", names_ptypes = numeric(),
                           values_to = "propMat_fctr") %>%
              mutate(agecl = as.numeric(agecl),
                     propMat = as.numeric(as.character(propMat_fctr)))

#Calculate habitat as the number of mature indivs * their condition ratio
numMat <- merge(truth$nums, matOgive, by.x = c("species", "agecl"), by.y = c("Name", "agecl"))
numMat <- numMat %>% dplyr::select(species, agecl, polygon, layer, time, atoutput, propMat) %>%
            mutate(numMat = atoutput * propMat)
numMat <- merge(numMat, condition, by = c("species", "agecl", "polygon", "layer", "time"))

numMat <- numMat %>% mutate(condIndex = numMat * condition)

numMat <- numMat %>% group_by(species, time) %>%
            dplyr::select(species, agecl, polygon, layer, time, condIndex) %>%
            dplyr::summarize(condIndex = sum(condIndex))

# ggplot() + 
#   geom_line(data=numMat, aes(x=time,y=condIndex), 
#             alpha = 10/10) +
#   facet_wrap(~species, ncol=3, nrow = 2, scales="free")

# aggregate by focal group similar to BDN
# Seafloor and Demersal Habitat
habDem <- numMat %>% filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "groundfish",
                                                      "Name"])
habDem <- habDem %>% group_by(time) %>%
            dplyr::summarize(habDem = sum(condIndex)) 

# plot(habDem$time, habDem$habDem, type = "l")

# Pelagic Habitat
habPel <- numMat %>% filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "forage",
                                                      "Name"])
habPel <- habPel %>% group_by(time) %>%
            dplyr::summarize(habPel = sum(condIndex)) 
# plot(habPel$time, habPel$habPel, type = "l")

# Nearshore Habitat
# Calculate wet weight of biomass pools using conversion in Atlantis manual, pg 151: weight_g = (1 + 2.65) * strutural N
# bps <- load_bps(dir = dir, fgs = file_fgs, file_init = file_init)
# fgs <- load_fgs(dir = dir, file_fgs = file_fgs)
invertPools <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = c("Filter_Other",
                                       "Deposit_Feeder",
                                       "Meiobenth"),
                     select_variable = "N", bboxes = bboxes)

# Subset for Nearshore Habitat
truthNear <- invertPools %>% filter(polygon == 5, layer == 4) %>%
                mutate(habNear = ConvertBiomassPool(groupSN = atoutput))

truthNear <- truthNear %>% group_by(time) %>% 
          dplyr::summarize(habNear = sum(habNear))
# ggplot() + geom_line(data = truthNear, aes(x=time,y=habNear))


# ------------ Environmental variables ----------------------------------------

# Pull salinity and temperature time series

#bboxes <- get_boundary(load_box(dir = dir, file_bgm = file_bgm))
truthTemp <- load_nc_physics(dir = dir, file_nc = paste0(scenario, ".nc"),
                             physic_variables = "Temp", aggregate_layers = FALSE, 
                             bboxes = bboxes)

truthSal <- load_nc_physics(dir = dir, file_nc = paste0(scenario, ".nc"),
                             physic_variables = "salt", aggregate_layers = FALSE, 
                             bboxes = bboxes)

truthPhys <- merge(truthTemp, truthSal, by = c("polygon", "layer", "time"))
truthPhys <- truthPhys %>% dplyr::select(polygon, layer, time, atoutput.x, atoutput.y) %>%
                rename(temp = atoutput.x, 
                       sal = atoutput.y) %>%
                filter(polygon %in% c(5, 7:11, 19))

# Use Chl-a for primary production indicator?
truthChla <- load_nc_physics(dir = dir, file_nc = paste0(scenario, ".nc"),
                             physic_variables = "Chl_a", aggregate_layers = TRUE, 
                             bboxes = bboxes)
truthChla <- truthChla %>% filter(polygon %in% c(5, 7:11, 19)) %>%
                group_by(time) %>%
                dplyr::summarize(PP = sum(atoutput)) #%>%
                #filter(!time %in% c(0,51))

truthPhys <- truthPhys %>% mutate(density = swRho(salinity = sal, temperature = temp, 
                                                  pressure = 0, eos = "unesco"))

# get temp and salinity at surface
surfaceST <- truthPhys %>% filter(layer == 0) %>%
                group_by(time) %>%
                dplyr::summarize(SST = mean(temp),
                                 SSS = mean(sal))

# get temp and salinity at bottom
bottomST <- truthPhys %>% filter(layer != 4) %>%
              group_by(polygon, time) %>%
              filter(layer == max(layer)) %>%
              ungroup() %>%
              group_by(time) %>%
              dplyr::summarize(BT = mean(temp),
                               BS = mean(sal))

# get stratification (density difference) in Box 10
strat <- truthPhys %>% filter(polygon == 10, layer %in% c(0,1)) %>%
            group_by(time) %>%
            mutate(strat = diff(density, lag = 1)) %>%
            filter(layer == 0) %>%
            arrange(time)

# plot(strat$time, strat$strat, type = "l")

# --------------------- Recreational Fishing Participation ------------------------
# Use record of recreational effort instead

file.catch <- file.path(dir, paste0(scenario, "Effort.txt"))
recEffort <- read.table(file.catch, header = TRUE)

# matplot(recEffort$Time/365, recEffort[,-c(1,26)], type = "l")

recEffort <- recEffort %>% dplyr::select(Time, recfish) %>%
                mutate(time = 1:nrow(recEffort)) %>%
                rename(recParticip = recfish)
# plot(recEffort$Time/365, recEffort$recParticip)

# ---------------- Focal Groups: PS ---------------------------
# Create timeseries of categories for baleen whales and pinnipeds

marmams <- truth$nums %>% dplyr::filter(species %in% c("Pinniped", "Whale_Baleen"), 
                                        polygon %in% c(5, 7:11, 19)) 

marmams <- marmams %>%
              group_by(species, time) %>% 
              dplyr::summarize(Num = sum(atoutput))
# ggplot() + geom_line(data = marmams, aes(x=time,y=Num)) +
#       facet_wrap(~species, scales = "free")

marmams <- marmams %>% pivot_wider(names_from = species, values_from = Num)

# modify code from ProcessData.Rmd
marmams$catHL <- ifelse(test = marmams$Pinniped < mean(marmams$Pinniped),#log(greySeals$Mean...2) < mean(log(greySeals$Mean...2)), 
                          yes = "Low", 
                          no = "High")
marmams$rwIorD <- NA
for(i in 1:(nrow(marmams)-1)){
  marmams$rwIorD[i+1] <- if(marmams$Whale_Baleen[i+1] < marmams$Whale_Baleen[i]){
                            "Decreasing"
                          } else {"Increasing"} # assumes no change = increasing
}

marmams$PS <- paste(marmams$catHL, marmams$rwIorD, sep = "")

# marmams <- marmams %>% filter(!time %in% c(0, 51))

# ----------------- Lower trophic components -------------------------------

# Gelatinous Zooplankton
gzGB <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = c("Gelat_Zoo"),
                     select_variable = "N", bboxes = bboxes)
gzGB <- gzGB %>% filter(polygon %in% c(5, 7:11, 19))

gzGB <- gzGB %>% group_by(species, time) %>% 
          dplyr::summarize(GZ = sum(atoutput))
# ggplot() + geom_line(data = gzGB, aes(x=time,y=GZ))

# Copepods and Micronekton
cmGB <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = c("Zoo", "MicroZoo"),
                     select_variable = "N", bboxes = bboxes)
cmGB <- cmGB %>% filter(polygon %in% c(5, 7:11, 19))

cmGB <- cmGB %>% group_by(time) %>% 
          dplyr::summarize(copepod = sum(atoutput))
# ggplot() + geom_line(data = cmGB, aes(x=time,y=copepod))

# Benthos
benthGB <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = indBDNLookup[indBDNLookup$BNindexGroup == "benthos", "Name"],
                     select_variable = "N", bboxes = bboxes)
benthGB <- benthGB %>% filter(polygon %in% c(5, 7:11, 19))

benthGB <- benthGB %>% group_by(time) %>% 
          dplyr::summarize(benthos = sum(atoutput))
# ggplot() + geom_line(data = benthGB, aes(x=time,y=benthos))

# Detritus & Bacteria
detBacGB <- load_nc(dir = dir, file_nc = paste0(scenario, ".nc"),
                     bps = bps, fgs = fgs, 
                     select_groups = indBDNLookup[indBDNLookup$BNindexGroup == "detBac", "Name"],
                     select_variable = "N", bboxes = bboxes)
detBacGB <- detBacGB %>% filter(polygon %in% c(5, 7:11, 19))

detBacGB <- detBacGB %>% group_by(time) %>% 
          dplyr::summarize(detBac = sum(atoutput))
# ggplot() + geom_line(data = detBacGB, aes(x=time,y=detBac))

# Mid-Atlantic Bight Groundfish
gfMABGB <- biomassTruth %>% filter(species %in% indBDNLookup[indBDNLookup$BNindexGroup == "gfMAB", "Name"]) %>%
            filter(polygon %in% c(5, 7:11, 19)) %>%
            group_by(time) %>% 
            dplyr::summarize(gfMAB = sum(atoutput))
# ggplot() + geom_line(data = gfMABGB, aes(x=time,y=gfMAB))

# Gather together for assessment model input

neusData <- bottomST %>% full_join(surfaceST, by = "time") %>%
                      full_join(strat, by = "time") %>%
                      full_join(truthChla, by = "time") %>%
                      full_join(detBacGB, by = "time") %>%
                       full_join(gfMABGB, by = "time") %>%
                       full_join(benthGB, by = "time") %>%
                       full_join(cmGB, by = "time") %>%
                       full_join(gzGB, by = "time") %>%
                       full_join(commSF, by = "time") %>%
                       full_join(commPel, by = "time") %>%
                       full_join(commGF, by = "time") %>%
                       full_join(habDem, by = "time") %>%
                       full_join(truthNear, by = "time") %>%
                       full_join(habPel, by = "time") %>%
                       full_join(invertsGB, by = "time") %>%
                       full_join(groundGB, by = "time") %>%
                       full_join(forageGB, by = "time") %>%
                       full_join(marmams, by = "time") %>%
                       full_join(recEffort, by = "time") %>%
                       select(time, BT, BS, SST, SSS, strat, PP, detBac, 
                              gfMAB, benthos, copepod, GZ, 
                              commSF, commPel, commGF, habDem, habNear, habPel, 
                              inverts, ground, forage, PS, recParticip)

return(neusData)

}
```

# Run extraction function on Atlantis NEUS scenario output
```{r}
# Bring in lookup of Atlantis codes and names for BDN node indices
indBDNLookup <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/NeusGroups_modforusewNEUS1.0.csv", 
                         stringsAsFactors = FALSE)
indBDNLookup <- indBDNLookup %>% dplyr::select(Code, Name, Long.Name, BNindexGroup) %>%
                  filter(BNindexGroup != "")

# ----- Baseline Scenario -----------------
# MSE scenario
scenarioMSEfolder <- "NeusScenario_baseline"

# function args
scenario = "NeusScenario_baseline" # Output file prefix
dir = paste0("C:/Users/rwildermuth/Documents/AtlantisTesting/FishingScenarios/",
             scenarioMSEfolder)
file_fgs = "NeusGroups_modforusewNEUS1.0.csv"
file_bgm = "neus30_2006.bgm" # geography bgm for box definitions
select_groups = indBDNLookup$Name
file_init = "inneus_2007.nc" # initial condition .nc file
file_biolprm = "at_biol_neus_Oct10B_Jason_FE.prm" # -b flag in the batch file


neusBaseline <- CompileNEUSIndicators(bdnLookup = indBDNLookup,
                                      scenario = scenario,
                                      dir = dir, 
                                      file_fgs = file_fgs,
                                      file_bgm = file_bgm,
                                      select_groups = select_groups, 
                                      file_init = file_init,
                                      file_biolprm = file_biolprm)


# trim and save NEUS scenario data
neusBaseline <- neusBaseline %>% filter(time > 0) %>%
                      filter(time <= 70)

# save(neusBaseline, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusBaseline.RData")

# ----- Wind Scenario -----------------
# MSE scenario
scenarioMSEfolder <- "NeusScenario_wind"

# function args
scenario = "NeusScenario_wind" # Output file prefix
dir = paste0("C:/Users/rwildermuth/Documents/AtlantisTesting/FishingScenarios/",
             scenarioMSEfolder)

neusWind <- CompileNEUSIndicators(bdnLookup = indBDNLookup,
                                      scenario = scenario,
                                      dir = dir, 
                                      file_fgs = file_fgs,
                                      file_bgm = file_bgm,
                                      select_groups = select_groups, 
                                      file_init = file_init,
                                      file_biolprm = file_biolprm)


# trim and save NEUS scenario data
neusWind <- neusWind %>% filter(time > 0) %>%
                      filter(time <= 70)

# save(neusWind, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusWind.RData")

# ----- Inc Fishing Scenario -----------------
# MSE scenario
scenarioMSEfolder <- "NeusScenario_doubleF"

# function args
scenario = "NeusScenario_doubleF" # Output file prefix
dir = paste0("C:/Users/rwildermuth/Documents/AtlantisTesting/FishingScenarios/",
             scenarioMSEfolder)

neusIncFish <- CompileNEUSIndicators(bdnLookup = indBDNLookup,
                                      scenario = scenario,
                                      dir = dir, 
                                      file_fgs = file_fgs,
                                      file_bgm = file_bgm,
                                      select_groups = select_groups, 
                                      file_init = file_init,
                                      file_biolprm = file_biolprm)


# trim and save NEUS scenario data
neusIncFish <- neusIncFish %>% filter(time > 0) %>%
                      filter(time <= 70)

# save(neusIncFish, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusIncFish.RData")

# ----- Dec Fishing Scenario -----------------
# MSE scenario
scenarioMSEfolder <- "NeusScenario_halveF"

# function args
scenario = "NeusScenario_halveF" # Output file prefix
dir = paste0("C:/Users/rwildermuth/Documents/AtlantisTesting/FishingScenarios/",
             scenarioMSEfolder)

neusDecFish <- CompileNEUSIndicators(bdnLookup = indBDNLookup,
                                      scenario = scenario,
                                      dir = dir, 
                                      file_fgs = file_fgs,
                                      file_bgm = file_bgm,
                                      select_groups = select_groups, 
                                      file_init = file_init,
                                      file_biolprm = file_biolprm)


# trim and save NEUS scenario data
neusDecFish <- neusDecFish %>% filter(time > 0) %>%
                      filter(time <= 70)

# save(neusDecFish, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusDecFish.RData")

```

# Compare output to QNM model
## Baseline
```{r}
load(file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusBaseline.RData")
load(file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusWind.RData")
load(file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusDecFish.RData")
load(file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusIncFish.RData")


# First check for stability at end of scenario
CheckStable <- function(dat){
  dat %>% pivot_longer(cols = -c(time, PS), names_to = "variable") %>%
                  ggplot() +
                    geom_line(aes(x=time,y=value, #color="catch atlantisom"
                                                        ), 
                              alpha = 10/10) +
                    theme_minimal() +
                    theme(legend.position = "top") 
}

CheckStable(neusBaseline) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 1) 
CheckStable(neusBaseline) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 2)
CheckStable(neusBaseline) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 3)


```
## Wind Energy
```{r}
CheckStable(neusWind) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 1) 
CheckStable(neusWind) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 2)
CheckStable(neusWind) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 3)
```
## Increased Fishing
```{r}
CheckStable(neusIncFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 1) 
CheckStable(neusIncFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 2)
CheckStable(neusIncFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 3)
```

## Decreased Fishing
```{r}
CheckStable(neusDecFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 1) 
CheckStable(neusDecFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 2)
CheckStable(neusDecFish) + facet_wrap_paginate(~variable, ncol=3, nrow = 3, scales="free", page = 3)
```

```{r}
# load historic data and find mean of last 5 years
load(file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/neusHistoricData.RData")

# Write processing function then apply over each scenario's table
ProcessLast5y <- function(dataTbl, # Scenario data table with numeric vals
                          scenarioName # Character lable for the scenario
                          ){
  sumTbl <- dataTbl %>% #select(-"PS") %>%
                  filter(time >= (nrow(dataTbl)-4)) %>%
                  mutate(scenario = scenarioName)
  
  # # add summary of character/categorical data
  # sumTbl$PS <- dataTbl %>% select(time, PS) %>%
  #                 filter(time >= (nrow(dataTbl)-4)) %>%
  
  return(sumTbl)
                          }

qnmOutcomes <- rbind(ProcessLast5y(dataTbl = neusHistoricData, scenarioName = "Historic"),
                     # include last 5 years before scenarios applied
                     ProcessLast5y(dataTbl = neusBaseline[neusBaseline$time <= 20, ], scenarioName = "Initial"),
                     ProcessLast5y(dataTbl = neusBaseline, scenarioName = "Baseline"),
                     ProcessLast5y(dataTbl = neusWind, scenarioName = "Energy"),
                     ProcessLast5y(dataTbl = neusIncFish, scenarioName = "IncFish"),
                     ProcessLast5y(dataTbl = neusDecFish, scenarioName = "DecFish"))
  
outPS <- qnmOutcomes %>% select(scenario, PS) %>%
            group_by(scenario) %>%
            mutate(PS=names(which.max(table(PS)))) %>%
            unique()
outPS

qnmOutcomes <- qnmOutcomes %>% group_by(scenario) %>% #select(-"PS") %>%
                  dplyr::summarise_at(vars(-PS), mean)

  
# qnmOutcomes <- merge(qnmOutcomes, outPS)
# 
# qnmOutcomes <- qnmOutcomes %>% mutate_at(vars(-PS), )

runs <- qnmOutcomes$scenario[qnmOutcomes$scenario != "Initial"]
for(i in runs){
  qnmOutcomes <- qnmOutcomes %>% add_row(scenario = i, 
                          qnmOutcomes[qnmOutcomes$scenario == i, -1] - qnmOutcomes[qnmOutcomes$scenario == "Initial", -1])
}

qnmOutcomes
```

# QNM results from Ch 1
```{r}
# Load original model results
adjMat <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch1GBQNMresults/adjMat2.0.csv",
                   stringsAsFactors = FALSE)
totMat <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch1GBQNMresults/totalFeedback2.0.csv",
                   stringsAsFactors = FALSE)
weightMat <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch1GBQNMresults/weightedFeedback2.0.csv",
                   stringsAsFactors = FALSE)

# calculate simultaneous presses as sum of individual columns
mmiQNMScenarios <- data.frame(node = adjMat$X,
                              baselineSSTAdj = adjMat$Surface.Temperature,
                              baselineSSTTot = totMat$Surface.Temperature,
                              baselineSSTWeight = weightMat$Surface.Temperature,
                              fishingNode1Adj = adjMat[, "Commercial.Groundfish.Fishery"],
                              fishingNode2Adj = adjMat[, "Commercial.Shellfish.Fishery"],
                              fishingNode3Adj = adjMat[, "Commercial.Pelagic.Fishery"],
                              fishingNode1Tot = totMat[, "Commercial.Groundfish.Fishery"],
                              fishingNode2Tot = totMat[, "Commercial.Shellfish.Fishery"],
                              fishingNode3Tot = totMat[, "Commercial.Pelagic.Fishery"],
                              energyNode1Adj = adjMat[, "Habitat..Nearshore"],
                              energyNode2Adj = adjMat[, "Habitat..Seafloor...Demersal"],
                              energyNode1Tot = totMat[, "Habitat..Nearshore"],
                              energyNode2Tot = totMat[, "Habitat..Seafloor...Demersal"])

# make sure to include warming in comparison scenarios
mmiQNMScenarios$fishingSumAdj <- rowSums(mmiQNMScenarios[, c("baselineSSTAdj",
                                                             "fishingNode1Adj",
                                                             "fishingNode2Adj",
                                                             "fishingNode3Adj")])
mmiQNMScenarios$fishingSumTot <- rowSums(mmiQNMScenarios[, c("baselineSSTTot",
                                                             "fishingNode1Tot",
                                                             "fishingNode2Tot",
                                                             "fishingNode3Tot")])
mmiQNMScenarios$fishingWeight <- abs(mmiQNMScenarios$fishingSumAdj)/mmiQNMScenarios$fishingSumTot

# negate adjacency values for decreases
mmiQNMScenarios$decFishSumAdj <- rowSums(-mmiQNMScenarios[, c("fishingNode1Adj",
                                                              "fishingNode2Adj",
                                                              "fishingNode3Adj")])
mmiQNMScenarios$decFishSumAdj <- mmiQNMScenarios$decFishSumAdj + mmiQNMScenarios$baselineSSTAdj
mmiQNMScenarios$decFishWeight <- abs(mmiQNMScenarios$decFishSumAdj)/mmiQNMScenarios$fishingSumTot

mmiQNMScenarios$energySumAdj <- rowSums(-mmiQNMScenarios[, c("energyNode1Adj",
                                                             "energyNode2Adj")])
mmiQNMScenarios$energySumAdj <- mmiQNMScenarios$energySumAdj + mmiQNMScenarios$baselineSSTAdj
mmiQNMScenarios$energySumTot <- rowSums(mmiQNMScenarios[, c("baselineSSTTot",
                                                            "energyNode1Tot",
                                                            "energyNode2Tot")])
mmiQNMScenarios$energyWeight <- abs(mmiQNMScenarios$energySumAdj)/mmiQNMScenarios$energySumTot

# write.csv(mmiQNMScenarios, 
#           file = 'C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch1GBQNMresults/Ch4_multimodelQNM_ScenarioResults.csv')

```


# Compare sign outcomes from QNMs and Atlantis output
```{r}
mmiQNMScenarios <- read.csv('C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch1GBQNMresults/Ch4_multimodelQNM_ScenarioResults.csv',
                            stringsAsFactors = FALSE)
mmiQNMScenarios$node <- gsub(".", "", x = mmiQNMScenarios$node, fixed = TRUE)

# include scenarios without climate change
mmiQNMScenarios$fishingNoCCSumAdj <- rowSums(mmiQNMScenarios[, c("fishingNode1Adj",
                                                             "fishingNode2Adj",
                                                             "fishingNode3Adj")])
mmiQNMScenarios$fishingNoCCSumTot <- rowSums(mmiQNMScenarios[, c("fishingNode1Tot",
                                                             "fishingNode2Tot",
                                                             "fishingNode3Tot")])
mmiQNMScenarios$fishingNoCCWeight <- abs(mmiQNMScenarios$fishingNoCCSumAdj)/mmiQNMScenarios$fishingNoCCSumTot

# negate adjacency values for decreases
mmiQNMScenarios$decFishNoCCSumAdj <- rowSums(-mmiQNMScenarios[, c("fishingNode1Adj",
                                                              "fishingNode2Adj",
                                                              "fishingNode3Adj")])
mmiQNMScenarios$decFishNoCCWeight <- abs(mmiQNMScenarios$decFishNoCCSumAdj)/mmiQNMScenarios$fishingNoCCSumTot

mmiQNMScenarios$energyNoCCSumAdj <- rowSums(-mmiQNMScenarios[, c("energyNode1Adj",
                                                             "energyNode2Adj")])
mmiQNMScenarios$energyNoCCSumTot <- rowSums(mmiQNMScenarios[, c("energyNode1Tot",
                                                            "energyNode2Tot")])
mmiQNMScenarios$energyNoCCWeight <- abs(mmiQNMScenarios$energyNoCCSumAdj)/mmiQNMScenarios$energyNoCCSumTot



nodeLookup <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/NEUS_MSE/nodeLookup_QNM_BDN.csv",
                       stringsAsFactors = FALSE)

qnmCompare <- qnmOutcomes %>% filter(time == 50) %>% 
                select(-time) %>% 
  # add variable for change in protected species from outPS
                mutate(PS = -1) %>% # HighIncreasing to HighDecreasing in all scenarios
                pivot_longer(cols = -scenario, names_to = "node", values_to = "outcome") %>%
                mutate(model = "NEUS",
                       weight = NA) %>%
                inner_join(nodeLookup, by = c("node" = "BDNnode")) %>%
                select(-node) %>%
                rename(node = QNMnode)

# get weights for pch sizing in figures
mmiQNMScenarioWeights <- mmiQNMScenarios %>% select(node, baselineSSTWeight, fishingWeight, decFishWeight, energyWeight,
                                              fishingNoCCWeight, decFishNoCCWeight, energyNoCCWeight) %>%
                      rename(Baseline = baselineSSTWeight,
                             DecFish = decFishWeight,
                             IncFish = fishingWeight,
                             Energy = energyWeight,
                             IncFishNoCC = fishingNoCCWeight, 
                             DecFishNoCC = decFishNoCCWeight, 
                             EnergyNoCC = energyNoCCWeight) %>%
                      pivot_longer(cols = -node, names_to = "scenario", values_to = "weight")

mmiQNMScenarios <- mmiQNMScenarios %>% select(node, baselineSSTAdj, fishingSumAdj, decFishSumAdj, energySumAdj,
                                              fishingNoCCSumAdj, decFishNoCCSumAdj, energyNoCCSumAdj) %>%
                      rename(Baseline = baselineSSTAdj,
                             DecFish = decFishSumAdj,
                             IncFish = fishingSumAdj,
                             Energy = energySumAdj,
                             IncFishNoCC = fishingNoCCSumAdj, 
                             DecFishNoCC = decFishNoCCSumAdj, 
                             EnergyNoCC = energyNoCCSumAdj) %>%
                      pivot_longer(cols = -node, names_to = "scenario", values_to = "outcome") %>%
                      mutate(model = "mmiQNM") %>%
                      inner_join(mmiQNMScenarioWeights)

# read in results from MSE of QNM fitted to NEUS data
mseQNMScenarios <- read.csv('C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/NEUS_MSE/qnmScenarios_Truth_20210310.csv',
                            stringsAsFactors = FALSE)

# include scenarios without climate change
mseQNMScenarios$fishingNoCCSumAdj <- rowSums(mseQNMScenarios[, c("fishingNode1Adj",
                                                             "fishingNode2Adj",
                                                             "fishingNode3Adj")])
mseQNMScenarios$fishingNoCCSumTot <- rowSums(mseQNMScenarios[, c("fishingNode1Tot",
                                                             "fishingNode2Tot",
                                                             "fishingNode3Tot")])
mseQNMScenarios$fishingNoCCWeight <- abs(mseQNMScenarios$fishingNoCCSumAdj)/mseQNMScenarios$fishingNoCCSumTot

# negate adjacency values for decreases
mseQNMScenarios$decFishNoCCSumAdj <- rowSums(-mseQNMScenarios[, c("fishingNode1Adj",
                                                              "fishingNode2Adj",
                                                              "fishingNode3Adj")])
mseQNMScenarios$decFishNoCCWeight <- abs(mseQNMScenarios$decFishNoCCSumAdj)/mseQNMScenarios$fishingNoCCSumTot

mseQNMScenarios$energyNoCCSumAdj <- rowSums(-mseQNMScenarios[, c("energyNode1Adj",
                                                             "energyNode2Adj")])
mseQNMScenarios$energyNoCCSumTot <- rowSums(mseQNMScenarios[, c("energyNode1Tot",
                                                            "energyNode2Tot")])
mseQNMScenarios$energyNoCCWeight <- abs(mseQNMScenarios$energyNoCCSumAdj)/mseQNMScenarios$energyNoCCSumTot

# get weights for pch sizing in figures
mseQNMScenarioWeights <- mseQNMScenarios %>% select(node, baselineSSTWeight, fishingWeight, decFishWeight, energyWeight,
                                              fishingNoCCWeight, decFishNoCCWeight, energyNoCCWeight) %>%
                      rename(Baseline = baselineSSTWeight,
                             DecFish = decFishWeight,
                             IncFish = fishingWeight,
                             Energy = energyWeight,
                             IncFishNoCC = fishingNoCCWeight, 
                             DecFishNoCC = decFishNoCCWeight, 
                             EnergyNoCC = energyNoCCWeight) %>%
                      pivot_longer(cols = -node, names_to = "scenario", values_to = "weight")

mseQNMScenarios <- mseQNMScenarios %>% select(node, baselineSSTAdj, fishingSumAdj, decFishSumAdj, energySumAdj,
                                              fishingNoCCSumAdj, decFishNoCCSumAdj, energyNoCCSumAdj) %>%
                      rename(Baseline = baselineSSTAdj,
                             DecFish = decFishSumAdj,
                             IncFish = fishingSumAdj,
                             Energy = energySumAdj,
                             IncFishNoCC = fishingNoCCSumAdj, 
                             DecFishNoCC = decFishNoCCSumAdj, 
                             EnergyNoCC = energyNoCCSumAdj) %>%
                      pivot_longer(cols = -node, names_to = "scenario", values_to = "outcome") %>%
                      mutate(model = "mseQNMtruth") %>%
                      inner_join(mseQNMScenarioWeights)

qnmCompare <- rbind(qnmCompare, mmiQNMScenarios, mseQNMScenarios)

qnmCompare$sign <- sign(qnmCompare$outcome)

qnmCompare %>% filter(node == "ProtectedSpecies")
```

# Compare outcomes from BDNs and Atlantis output
```{r}
mseBDNScenarios <- read.table("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/NEUS_MSE/GB_NEUS_MSE_NoErr_ScenarioBeliefs_20210218.txt", 
                              header = TRUE, sep="\t", row.names = NULL, stringsAsFactors = FALSE)
mmiBDNScenarios <- read.table("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/ch2GBBDNresults/GB_BDN_MMI_ScenarioBeliefs_20210218.txt", 
                              header = TRUE, sep="\t", row.names = NULL, stringsAsFactors = FALSE)

mseBDNScenarios <- mseBDNScenarios %>% mutate(model = "mseBDNtruth")
mmiBDNScenarios <- mmiBDNScenarios %>% mutate(model = "mmiBDN")

bdnCompare <- rbind(mseBDNScenarios, mmiBDNScenarios)

#bdnCompare <- bdnCompare %>% select(model, starts_with("most.prob"))

# Instead, report estimated probabilities of the favored state (or high state)
bdnCompare <- bdnCompare %>% select(model, most.prob.Strategy, 
                                    P.soccultvals2.Better.,
                                    P.soccultvals3.Better.,
                                    P.recParticip2.High.,
                                    P.recParticip3.High.,
                                    P.employment2.High.,
                                    P.employment3.High.,
                                    P.seafood2.High.,
                                    P.seafood3.High.,
                                    P.profits2.High.,
                                    P.profits3.High.,
                                    P.habDem2.High.,
                                    P.habDem3.High.,
                                    P.habPel2.High.,
                                    P.habPel3.High.,
                                    P.habNear2.Increasing.,
                                    P.habNear3.Increasing.,
                                    P.forage2.Above_Bmsy.,
                                    P.forage3.Above_Bmsy.,
                                    P.ground2.Above_Bmsy.,
                                    P.ground3.Above_Bmsy.,
                                    P.inverts2.Above_Bmsy.,
                                    P.inverts3.Above_Bmsy.,
                                    P.PS2.HighIncreasing.,
                                    P.PS3.HighIncreasing.,
                                    P.gfMAB2.High.,
                                    P.gfMAB3.High.,
                                    P.commGF2.Below_MSY.,
                                    P.commGF3.Below_MSY.,
                                    P.commSF2.Below_MSY.,
                                    P.commSF3.Below_MSY.,
                                    P.commPel2.Below_MSY.,
                                    P.commPel3.Below_MSY.,
                                    P.GZ2.High.,
                                    P.GZ3.High.,
                                    P.benthos2.High.,
                                    P.benthos3.High.,
                                    P.detBac2.High.,
                                    P.detBac3.High.,
                                    P.copepod2.High.,
                                    P.copepod3.High.,
                                    P.PP2.High.,
                                    P.PP3.High.,
                                    P.strat2.High.,
                                    P.strat3.High.,
                                    P.SST2.High.,
                                    P.SST3.High.,
                                    P.BT2.High.,
                                    P.BT3.High.,
                                    P.SSS2.High.,
                                    P.SSS3.High.,
                                    P.BS2.High.,
                                    P.BS3.High.)

```

Process the NEUS scenario output using similar scaling, etc. as BDNDataPrep_GB.R
```{r}
# Load and scale BDN MSE dataset derived from NEUS historical data
bdnMSEData <- read.csv("C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/NEUS_MSE/GB_BDN_MSE_data_20210125.csv",
                      stringsAsFactors = FALSE)

# Create threshold lookup table with scaling info for MSE data
tHoldMSE <- tHold %>% mutate(center = NA,
                             scale = NA)

# Scale and center raw data indices (not anomalies, percentages, or categorical variables)
# Need to create anomalies for Temp and Sal data and copepods

# make list of variables to loop through
# create the scale and extract center and scale
# insert into tHoldMSE based on looped variable
vars <- c("BT", "BS", "SST", "SSS", "copepod", "gfMAB", "GZ", "strat", "habPel", 
          "habDem", "PP", "detBac", "benthos", "commPel", "commGF", "commSF", "recParticip")

for(i in vars){
  varScale <- scale(bdnMSEData[, i], center = TRUE, scale = TRUE)
  
  tHoldMSE[which(tHoldMSE$Node == i), "center"] <- attr(varScale, "scaled:center")
  tHoldMSE[which(tHoldMSE$Node == i), "scale"] <- attr(varScale, "scaled:scale")
}

# Scaled thresholds:
# MSY estimates
fi <- read.delim("NEUS_MSE/prodmodel_SF20210118_NoObsErr.cor", skip = 1, sep="")
fi <- fi[,1:4]
fiMSY <- fi[fi$name == "MSY", "value"]
sfScale <- scale(bdnMSEData$commSF, center = TRUE, scale = TRUE)
tHoldMSE[which(tHoldMSE$Node == "commSF"), "tHold"] <- (log(fiMSY)-attr(sfScale, "scaled:center"))/attr(sfScale, "scaled:scale")

ff <- read.delim("NEUS_MSE/prodmodel_FF20210123_NoObsErr.cor", skip = 1, sep="")
ff <- ff[,1:4]
ffMSY <- ff[ff$name == "MSY", "value"]
ffScale <- scale(bdnMSEData$commPel, center = TRUE, scale = TRUE)
tHoldMSE[which(tHoldMSE$Node == "commPel"), "tHold"] <- (log(ffMSY)-attr(ffScale, "scaled:center"))/attr(ffScale, "scaled:scale")

gf <- read.delim("NEUS_MSE/prodmodel_GF20210120_NoObsErr.cor", skip = 1, sep="")
gf <- gf[,1:4]
gfMSY <- gf[gf$name == "MSY", "value"]
gfScale <- scale(bdnMSEData$commGF, center = TRUE, scale = TRUE)
tHoldMSE[which(tHoldMSE$Node == "commGF"), "tHold"] <- (log(gfMSY)-attr(gfScale, "scaled:center"))/attr(gfScale, "scaled:scale")

tHoldMSE[which(tHoldMSE$Node == "recParticip"), "tHold"] <- 0

# Colate NEUS outputs and translate to BDN states
# processing function then apply over each scenario's table
ProcessFrst2y <- function(dataTbl, # Scenario data table with numeric vals
                          scenarioName # Character lable for the scenario
                          ){
  sumTbl <- dataTbl %>% 
                  filter(time <= 2) %>%
                  mutate(scenario = scenarioName)
  
  # Need to turn habNear into percentage change data
  sumTbl$habNearPct <- NA
  for(i in 2:nrow(sumTbl)){
    sumTbl$habNearPct[i] <- (((sumTbl$habNear[i]/sumTbl$habNear[i-1])^(1/2))-1)*100
  }
  #sumTbl %>% dplyr::select(time, habNear, habNearPct)
  
  sumTbl$habNear <- sumTbl$habNearPct
  
  return(sumTbl)
                          }

bdnOutcomes <- rbind(ProcessFrst2y(dataTbl = neusBaseline, scenarioName = "Baseline"),
                     ProcessFrst2y(dataTbl = neusWind, scenarioName = "Energy"),
                     ProcessFrst2y(dataTbl = neusIncFish, scenarioName = "IncFish"),
                     ProcessFrst2y(dataTbl = neusDecFish, scenarioName = "DecFish"))

# Next scale NEUS output and compare to thresholds in 'tHoldMSE'

# Log-transform biomass  and count indices first
bdnOutcomes$gfMAB <- log(bdnOutcomes$gfMAB)
bdnOutcomes$GZ <- log(bdnOutcomes$GZ)
bdnOutcomes$copepod <- log(bdnOutcomes$copepod)
bdnOutcomes$benthos <- log(bdnOutcomes$benthos)
bdnOutcomes$commPel <- log(bdnOutcomes$commPel)
bdnOutcomes$commGF <- log(bdnOutcomes$commGF)
bdnOutcomes$commSF <- log(bdnOutcomes$commSF)
bdnOutcomes$recParticip <- log(bdnOutcomes$recParticip)

for(i in vars){
  
  bdnOutcomes[, paste0(i, "scaled")] <- (bdnOutcomes[, i] - tHoldMSE[tHoldMSE$Node == i, "center"])/tHoldMSE[tHoldMSE$Node == i, "scale"]
  
  bdnOutcomes[, i] <- if_else(bdnOutcomes[, paste0(i, "scaled")] < tHoldMSE[tHoldMSE$Node == i, "tHold"], 
                                 true = tHoldMSE[tHoldMSE$Node == i, "lowState"],
                                 false = tHoldMSE[tHoldMSE$Node == i, "hiState"])
}

# Discretize nearshore habitat variable
bdnOutcomes$habNear <- if_else(bdnOutcomes$habNear < tHoldMSE[tHoldMSE$Node == "habNear", "tHold"], 
                                 true = tHoldMSE[tHoldMSE$Node == "habNear", "lowState"],
                                 false = tHoldMSE[tHoldMSE$Node == "habNear", "hiState"])

# Determine if biomass is above/below Bmsy based on index point estimate
# First apply catchability and 75% survey coverage to biomass timeseries
qFF <- 0.1383182
bdnOutcomes$forage <- bdnOutcomes$forage * qFF * 0.75
# translate index into biomass estimate based on line 187 of prodmodel.tpl
bdnOutcomes$forage <- exp(log(bdnOutcomes$forage) - log(na.omit(ff[ff$name == "q", "value"]))) - 1.e-07
# calculate ratio of estimated biomass to Bmsy
bdnOutcomes$forageRatio <- bdnOutcomes$forage/ff[ff$name == "Bmsy", "value"]
# Discretize forage biomass ratio variable
bdnOutcomes$forage <- if_else(bdnOutcomes$forageRatio < 1, 
                              true = tHoldMSE[tHoldMSE$Node == "forage", "hiState"], # switch these b/c not measuring probability, just whether above or below Bmsy
                              false = tHoldMSE[tHoldMSE$Node == "forage", "lowState"])

# First apply catchability and 75% survey coverage to biomass timeseries
qGF <- 0.182875
bdnOutcomes$ground <- bdnOutcomes$ground * qGF * 0.75
# translate index into biomass estimate based on line 187 of prodmodel.tpl
bdnOutcomes$ground <- exp(log(bdnOutcomes$ground) - log(na.omit(gf[gf$name == "q", "value"]))) - 1.e-07
# calculate ratio of estimated biomass to Bmsy
bdnOutcomes$groundRatio <- bdnOutcomes$ground/gf[gf$name == "Bmsy", "value"]
# Discretize forage biomass ratio variable
bdnOutcomes$ground <- if_else(bdnOutcomes$groundRatio < 1, 
                              true = tHoldMSE[tHoldMSE$Node == "ground", "hiState"], # switch these b/c not measuring probability, just whether above or below Bmsy
                              false = tHoldMSE[tHoldMSE$Node == "ground", "lowState"])

# translate index into biomass estimate based on line 187 of prodmodel.tpl
bdnOutcomes$inverts <- exp(log(bdnOutcomes$inverts) - log(na.omit(fi[fi$name == "q", "value"]))) - 1.e-07
# calculate ratio of estimated biomass to Bmsy
bdnOutcomes$invertsRatio <- bdnOutcomes$inverts/fi[fi$name == "Bmsy", "value"]
# Discretize forage biomass ratio variable
bdnOutcomes$inverts <- if_else(bdnOutcomes$invertsRatio < 1, 
                              true = tHoldMSE[tHoldMSE$Node == "inverts", "hiState"], # switch these b/c not measuring probability, just whether above or below Bmsy
                              false = tHoldMSE[tHoldMSE$Node == "inverts", "lowState"])
bdnOutcomes
```
# Combine BDN output together in one table
```{r}
# bdnCompare <- bdnCompare %>% rename(scenario = most.prob.Strategy) %>%
#                 pivot_longer(cols = -c("model","scenario"), names_to = c("node", "time"), names_prefix = "most.prob.", 
#                              names_sep = -1, values_to = "outcome") %>%
#                 mutate(time = as.numeric(time) - 1)

bdnCompare <- bdnCompare %>% rename(scenario = most.prob.Strategy) %>%
                pivot_longer(cols = -c("model","scenario"), names_to = "node", names_prefix = "P.", 
                             values_to = "probFavored") %>% 
                separate(col = node, into = c("node", "state", NA), sep = "\\.") %>% # Separate into three columns by period
                separate(col = node, into = c("node","time"), sep = "(?<=[A-Za-z])(?=[0-9])")  %>% # Separate column into two columns by text and number
                mutate(time = as.numeric(time) - 1)


bdnCompare$scenario <- recode(bdnCompare$scenario, Maintain_Fishing = "Baseline",
                                                   Increase_Fishing = "IncFish",
                                                   Decrease_Fishing = "DecFish",
                                                   Energy_Extraction = "Energy")

bdnOutcomes <- bdnOutcomes %>% select(cols = -c(contains("Scaled"), contains("Ratio"), contains("Pct"))) %>%
                  pivot_longer(cols = -c("scenario", "time"), names_to = "node", values_to = "state") %>%
                  mutate(model = "NEUS",
                         probFavored = NA) # fill this in by hand for now

bdnCompare <- rbind(bdnCompare, bdnOutcomes)

bdnCompare %>% filter(model == "NEUS",
                      time == 2)
```


Format tables for ms
```{r}
wideQNMout <- qnmCompare %>% select(-outcome, -weight) %>%
                pivot_wider(names_from = c(model, scenario), values_from = sign)
# write.csv(wideQNMout, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/results/QNMresults_20210310.csv")

wideBDNout <- bdnCompare %>% filter(time == 2) %>%
                select(-time) %>%
                pivot_wider(names_from = c(model, scenario), values_from = probFavored) %>%
                inner_join(y = nodeLookup, by = c("node" = "BDNnode")) %>%
                relocate(QNMnode)
# write.csv(wideBDNout, file = "C:/Users/rwildermuth/Dropbox/PhD_UMass/ATLANTIS/omNEUS/results/BDNresults_20210309.csv")

```